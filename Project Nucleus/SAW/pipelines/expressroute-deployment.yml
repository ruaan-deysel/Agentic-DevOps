name: ExpressRoute-Deployment

# Trigger on changes to SAW ExpressRoute files
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "Project Nucleus/SAW/main.bicep"
      - "Project Nucleus/SAW/config/ms.expressroute/**"
      - "Project Nucleus/SAW/pipelines/expressroute-deployment.yml"

parameters:
  - name: environment
    displayName: Environment
    type: string
    default: prod
    values:
      - prod
  - name: resourceGroupName
    displayName: Resource Group Name
    type: string
    default: SAW-AE-PLT-CON-NET-RG001
  - name: whatIf
    displayName: What-If Deployment (No Changes)
    type: boolean
    default: false

variables:
  - name: templateFile
    value: "$(System.DefaultWorkingDirectory)/Project Nucleus/SAW/main.bicep"
  - name: parameterFile
    value: "$(System.DefaultWorkingDirectory)/Project Nucleus/SAW/config/ms.expressroute/parameters.bicepparam"
  - name: azureServiceConnection
    value: "SAW-PLT-CON-SUB001-ServiceConnection"

stages:
  - stage: Validate
    displayName: "Validate Templates"
    jobs:
      - job: ValidateTemplates
        displayName: "Validate Bicep Templates"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: AzureCLI@2
            displayName: "Validate Bicep Template"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Install latest Bicep CLI
                az bicep install --version latest

                # Validate Bicep template
                echo "Validating Bicep template: $(templateFile)"
                az bicep build --file "$(templateFile)"

                # Lint Bicep template
                echo "Linting Bicep template"
                az bicep lint --file "$(templateFile)"

                # Validate deployment with what-if
                echo "Validating deployment with what-if"
                az deployment group what-if \
                  --resource-group "${{ parameters.resourceGroupName }}" \
                  --template-file "$(templateFile)" \
                  --parameters "$(parameterFile)" \
                  --no-pretty-print

  - stage: Deploy
    displayName: "Deploy ExpressRoute"
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - deployment: DeployExpressRoute
        displayName: "Deploy ExpressRoute Circuit"
        environment: ${{ parameters.environment }}
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Deploy ExpressRoute Circuit"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Install latest Bicep CLI
                      az bicep install --version latest

                      # Verify current subscription context
                      SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                      SUBSCRIPTION_NAME=$(az account show --query name -o tsv)
                      echo "Using subscription: $SUBSCRIPTION_NAME ($SUBSCRIPTION_ID)"

                      # Install the Bicep registry module
                      echo "Installing Azure Verified Module for ExpressRoute Circuit"
                      az bicep install-module --target-module-name avm/res/network/express-route-circuit --version 0.3.0

                      # Deploy or perform what-if based on parameter
                      if [ "${{ parameters.whatIf }}" = "true" ]; then
                        echo "Performing what-if deployment (no changes will be made)"
                        az deployment group what-if \
                          --resource-group "${{ parameters.resourceGroupName }}" \
                          --template-file "$(templateFile)" \
                          --parameters "$(parameterFile)"
                      else
                        # Generate a unique deployment name
                        DEPLOYMENT_NAME="expressroute-$(date +%Y%m%d%H%M%S)"

                        echo "Deploying ExpressRoute circuit with name: $DEPLOYMENT_NAME"
                        az deployment group create \
                          --resource-group "${{ parameters.resourceGroupName }}" \
                          --name "$DEPLOYMENT_NAME" \
                          --template-file "$(templateFile)" \
                          --parameters "$(parameterFile)"
                        OUTPUTS=$(az deployment group show \
                          --resource-group "${{ parameters.resourceGroupName }}" \
                          --name "$DEPLOYMENT_NAME" \
                          --query "properties.outputs" \
                          -o json)

                        # Extract values from outputs
                        CIRCUIT_NAME=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitName.value')
                        SERVICE_KEY=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitServiceKey.value')
                        CIRCUIT_STATE=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitProvisioningState.value')
                        CONNECTION_NAME=$(echo "$OUTPUTS" | jq -r '.connectionName.value')
                        CONNECTION_STATE=$(echo "$OUTPUTS" | jq -r '.connectionProvisioningState.value')
                        TIMESTAMP=$(echo "$OUTPUTS" | jq -r '.deploymentTimestamp.value')

                        echo "##[section]ExpressRoute Circuit Deployed"
                        echo "##[command]Circuit Name: $CIRCUIT_NAME"
                        echo "##[command]Circuit State: $CIRCUIT_STATE"
                        echo "##[command]Service Key: $SERVICE_KEY"
                        echo "##[command]Connection Name: $CONNECTION_NAME"
                        echo "##[command]Connection State: $CONNECTION_STATE"
                        echo "##[command]Deployment Timestamp: $TIMESTAMP"
                        echo "##[warning]Important: Provide this service key to your service provider to complete the provisioning process."
                      fi

  - stage: PostDeployment
    displayName: "Post-Deployment Validation"
    dependsOn: Deploy
    condition: and(succeeded(), eq('${{ parameters.whatIf }}', 'false'))
    jobs:
      - job: ValidateDeployment
        displayName: "Validate Deployment"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: AzureCLI@2
            displayName: "Check ExpressRoute Circuit Status"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Find the latest deployment
                LATEST_DEPLOYMENT=$(az deployment group list \
                  --resource-group "${{ parameters.resourceGroupName }}" \
                  --query "[?contains(name, 'expressroute-')].{Name:name, Timestamp:properties.timestamp}" \
                  --output json | jq -r 'sort_by(.Timestamp) | reverse | .[0].Name')

                echo "Latest deployment: $LATEST_DEPLOYMENT"

                # Get deployment outputs
                OUTPUTS=$(az deployment group show \
                  --resource-group "${{ parameters.resourceGroupName }}" \
                  --name "$LATEST_DEPLOYMENT" \
                  --query "properties.outputs" \
                  -o json)

                # Extract values from outputs
                CIRCUIT_NAME=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitName.value')
                CIRCUIT_ID=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitId.value')
                SERVICE_KEY=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitServiceKey.value')
                CIRCUIT_STATE=$(echo "$OUTPUTS" | jq -r '.expressRouteCircuitProvisioningState.value')
                CONNECTION_NAME=$(echo "$OUTPUTS" | jq -r '.connectionName.value')
                CONNECTION_ID=$(echo "$OUTPUTS" | jq -r '.connectionId.value')
                CONNECTION_STATE=$(echo "$OUTPUTS" | jq -r '.connectionProvisioningState.value')
                TIMESTAMP=$(echo "$OUTPUTS" | jq -r '.deploymentTimestamp.value')

                # Check current circuit state (may have changed since deployment)
                CURRENT_CIRCUIT_STATE=$(az network express-route show \
                  --resource-group "${{ parameters.resourceGroupName }}" \
                  --name "$CIRCUIT_NAME" \
                  --query "provisioningState" \
                  -o tsv)

                echo "Current Circuit Provisioning State: $CURRENT_CIRCUIT_STATE"

                # Check current connection state (may have changed since deployment)
                CURRENT_CONNECTION_STATE=$(az network vpn-connection show \
                  --resource-group "${{ parameters.resourceGroupName }}" \
                  --name "$CONNECTION_NAME" \
                  --query "provisioningState" \
                  -o tsv 2>/dev/null || echo "Not found")

                echo "Current Connection Provisioning State: $CURRENT_CONNECTION_STATE"

                # Output summary
                echo "##[section]Deployment Summary"
                echo "##[command]Deployment Timestamp: $TIMESTAMP"
                echo "##[command]Circuit Name: $CIRCUIT_NAME"
                echo "##[command]Circuit State at Deployment: $CIRCUIT_STATE"
                echo "##[command]Circuit Current State: $CURRENT_CIRCUIT_STATE"
                echo "##[command]Service Key: $SERVICE_KEY"
                echo "##[command]Connection Name: $CONNECTION_NAME"
                echo "##[command]Connection State at Deployment: $CONNECTION_STATE"
                echo "##[command]Connection Current State: $CURRENT_CONNECTION_STATE"
                echo "##[warning]Important: Provide the service key to your service provider to complete the provisioning process."
